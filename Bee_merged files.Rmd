---
title: "R Notebook"
output: html_notebook
---

#Importing libraries
Importing dada2, phyloseq, ggplot2, seqinr, decodam, DESeq2, Biostrings, microeco, ape, ShortRead, dendextend, dplyr, ggpubr, fantaxtic, ggforce, microbiomeutilities, pheatmap, vegan, microbiome

```{r}
library('dada2')
library("phyloseq")
library("seqinr")
library("decontam")
library("ggplot2")
library("Biostrings")
library("DESeq2")
library("microeco")
library("ape")
library(ShortRead)
library(dendextend)
library(dplyr)
library(ggpubr)
library(fantaxtic)
library(ggforce)
library(microbiomeutilities)
library(pheatmap)
library(vegan)
library(microbiome)
```

Set theme for all ggplots 

```{r}
theme_set(theme_bw())
```

##Making files for analysis

#Import and filter files
CHANGE the path to the directory containing the fastq files after unzipping.
```{r}
path <- "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/MiSeq_SOP1" 
list.files(path)
```

Take filenames from directory and make list of it
```{r}
fnFs <- sort(list.files(path, pattern=".R1.fastq", full.names = TRUE)) #достаем имена файлов
fnRs <- sort(list.files(path, pattern=".R2.fastq", full.names = TRUE))

sample.names <- sapply(strsplit(basename(fnFs), "_"), `[`, 1)
```

Plot quality of seq
```{r}
plotQualityProfile(fnFs[1:10])
plotQualityProfile(fnRs[1:10])
```

Filter files and trunclen of our 16sRNA with normal quality of sample
```{r}
filtFs <- file.path(path, "filtered", paste0(sample.names, "_F_filt.fastq.gz"))
filtRs <- file.path(path, "filtered", paste0(sample.names, "_R_filt.fastq.gz"))

names(filtFs) <- sample.names
names(filtRs) <- sample.names

out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, truncLen=c(130,130),
                     maxN=0, maxEE=Inf, truncQ=2, rm.phix=FALSE,
                     compress=TRUE, multithread=TRUE) # On Windows set multithread=FALSE
head(out)
```

#Errors
Learn errors in our files, print plots and clean our data
```{r}
errF <- learnErrors(filtFs, multithread=TRUE)
errR <- learnErrors(filtRs, multithread=TRUE)

plotErrors(errF, nominalQ=TRUE)
plotErrors(errR, nominalQ=TRUE)

dadaFs <- dada(filtFs, err=errF, multithread=TRUE)
dadaRs <- dada(filtRs, err=errR, multithread=TRUE)
```

#Merge files
Merge files and inspect the merger data.frame from the first sample (Merge[1] shows exampl of mergers). After it construct seqtab table with our seq's with counts of it in every bee.
```{r}
mergers <- mergePairs(dadaFs, filtFs, dadaRs, filtRs, minOverlap=9, verbose=TRUE)
mergers[[1]]

seqtab <- makeSequenceTable(mergers)
dim(seqtab)
table(nchar(getSequences(seqtab)))
```
Remove chimeras and analys our data after it. If processing a single sample, remove the sapply calls: e.g. replace sapply(dadaFs, getN) with getN(dadaFs).
```{r}
seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)
dim(seqtab.nochim)
sum(seqtab.nochim)/sum(seqtab)

getN <- function(x) sum(getUniques(x))
track <- cbind(out, sapply(dadaFs, getN), sapply(dadaRs, getN), sapply(mergers, getN), rowSums(seqtab.nochim))

colnames(track) <- c("input", "filtered", "denoisedF", "denoisedR", "merged", "nonchim")
rownames(track) <- sample.names
head(track)
```
```{r}
write.csv(seqtab.nochim,"/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/seqtab.nochim.nonrep.csv", row.names = FALSE)
seqtab.nochim1 <- seqtab.nochim
saveRDS(seqtab, "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/seqtab.nonrep.rds") 
```

#Assign Taxonomy
Assign taxonomy and print it. Take data of taxas from directory

```{r}

taxa <- assignTaxonomy(seqtab.nochim, "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/silva_nr99_v138.1_train_set.fa.gz", multithread=TRUE)
taxa <- addSpecies(taxa, "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/silva_species_assignment_v138.1.fa.gz")
taxa.print <- taxa # Removing sequence rownames for display only
rownames(taxa.print) <- NULL
head(taxa.print)

```

Save sequences as fasta to the current directory. Here we should change directory for files from diffrent data! 
```{r}
asvnames <- sprintf("ASV_%04d", seq(1,nrow(taxa)))
write.fasta(as.list(rownames(taxa)), asvnames, 
            file.out = "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/asvs1.nonrep.fasta",  open = "w", as.string = TRUE)

rownames(taxa) <- asvnames
colnames(seqtab.nochim) <- asvnames
```

#Importing metadata
Connect Silva taxonomy to phyloseq (4 export only) and making count table with asv's rows and bee's columns
```{r}
ps.Silva <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE),
                     sample_data(sample.metadata1),
                     tax_table(taxa))

readcount.table <- cbind(t(ps.Silva@otu_table),ps.Silva@tax_table)
```

Importing files to thw directory. Change directoty for next analysis */Users/aleksandrakozlova/Desktop/Work/Kurchatnik/*
```{r}
write.csv(ps.Silva@tax_table, file = "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/MiSeq_SOP1/dada2.Silva.taxtab.nonrep.csv")
write.csv(t(ps.Silva@otu_table), file = "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/MiSeq_SOP1/dada2.Silva.otutab.nonrep.csv")
write.csv(readcount.table, file = "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/MiSeq_SOP1/dada2.Silva.sumtab.nonrep.csv")
```

##Making our phyloseq for the all anylysis
#Importing metadata 
Importing metadata from current dirrectory (header=FALSE). After it change the names of columns. Directory start = */Users/aleksandrakozlova/Desktop/Work/Kurchatnik/*.
```{r}
sample.metadata1 <- sample_data(read.csv(file = '/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/MiSeq_SOP1/Metadata_nonrep.csv',
                                        dec = ",",
                                        header = FALSE,
                                        row.names = 1 ) )
sample.metadata1 <- setNames(sample.metadata1, c("Bee / Gut","Place local","Place_Ossetia","bee_name","Hight","Hight1"))
```


#Import files for the next analysis
Import libraries back to the file. Change directoty for next analysis */Users/aleksandrakozlova/Desktop/Work/Kurchatnik/*
```{r}
otu <- otu_table(as.matrix(read.csv(file = "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/MiSeq_SOP1/dada2.Silva.otutab.nonrep.csv", row.names = 1)), taxa_are_rows = TRUE)
tax <- tax_table(as.matrix(read.csv(file = "/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/MiSeq_SOP1/dada2.Silva.taxtab.nonrep.csv", row.names = 1)))
```

#Make phyloseq for analysis 
Make phyloseq for analysis and removing mitochondria and c
```{r}
fin.phy.nrep <- phyloseq(sam_data = sample.metadata1, otu_table = otu, tax_table = tax, refseq = readcount.table)
fin.phy.nrep <- fin.phy.nrep %>% subset_taxa( Family!= "Mitochondria" | is.na(Family) & Class!="Chloroplast" | is.na(Class) )
```

##Analysis

#Make pheatmap

Firstly we should modify data for the next analysis.
Take genus for our asv's and make list. Take core members (with diffrent prevalence and detection). After that makeconnection with our phyloseq 

For genuses
```{r}
tax_glom_fin.phy.nrep <- tax_glom(fin.phy.nrep, "Genus" )

taxas1 <- core_members(tax_glom_fin.phy.nrep, detection = 3, prevalence = 1/100)
ps_obj1 <- prune_taxa(taxas1, tax_glom_fin.phy.nrep)
```

For asvs
```{r}
taxas1 <- core_members(fin.phy.nrep, detection = 3, prevalence = 5/100)
ps_obj1 <- prune_taxa(taxas1, fin.phy.nrep)
```


Make two functions for make df from our phyloseq and connect data about taxa for our asv's.
```{r}
taxa_name_func <- function(x) {paste0(x['ASV'], '__', x['Family'],  '.g__' , gsub('/', '', gsub("-", "", x['Genus'])))}
prepare_count_table <- function (ps_obj, taxa_name_func) {
  otu_matrix <- as(otu_table(ps_obj), 'matrix')
  taxa_matrix <- as(tax_table(ps_obj), 'matrix')
  taxa_matrix <- cbind(ASV=rownames(taxa_matrix), taxa_matrix)  
  taxa_matrix_good_names <- apply(taxa_matrix, MARGIN=1, taxa_name_func)
  rownames(otu_matrix) <- taxa_matrix_good_names
  return(otu_matrix)
}
```

Make our function work and give some arguments. After that normalize our data with log or clr function.
```{r}
count_mtrx <- prepare_count_table(ps_obj1, taxa_name_func) #задаем то, что берется в функцию
ps2 <- microbiome::transform(count_mtrx, "clr")
```


Here we should count our data for the correlation data and other! 
```{r}

```

Function for saving pdf with pheatmap
```{r}
save_pheatmap_pdf <- function(x, filename, width=12, height=7) {
  stopifnot(!missing(x))
  stopifnot(!missing(filename))
  pdf(filename, width=width, height=height)
  grid::grid.newpage()
  grid::grid.draw(x$gtable)
  dev.off()
}
```

Connect metadata with df (don't know how take the exist metadata ;(((( )
```{r}
readfile <- read.csv('/Users/aleksandrakozlova/Desktop/Work/Kurchatnik/Ossetian.bees/Metadata_nonrep.csv', header = TRUE)
readfile1 <- select(readfile, -Sample1, -bee_file, -Sample)
row.names(readfile1) <- colnames(ps2)

```

After all modifications we can plot the pheatmap and ssave it.
```{r}
xx <- pheatmap(ps2,cellwidth = 6, cellheight = 2.5,
         cluster_row = T,
         show_rownames = T,
         show_colnames = T,
         fontsize_row = 2, 
         fontsize_col = 5,
         fontsize = 5,
         annotation_col = readfile1, cluster_cols = FALSE, gaps_col = seq(2,82,by=2))

```

```{r}
xx$tree_row$order <- 
```

Save pheatmap for the dirrectory  *Change names in save_pheatmap_pdf!!!*
```{r}
save_pheatmap_pdf(xx, "clr_asv_5prc.pdf")
```

#Plot ordination

Transformation (otu/sum otu)
```{r}
ps.prop <- transform_sample_counts(fin.phy.nrep, function(otu) otu/sum(otu))
```
Drow ordination
```{r}
ps.prop <- transform_sample_counts(fin.phy.nrep, function(otu) otu/sum(otu))
ord.nmds.bray <- ordinate(ps.prop, method="NMDS", distance="bray")

plot_ordination(fin.phy.nrep, ord.nmds.bray, color='Place', shape = 'bee.gut', title="Bray NMDS",label="Sample1")

```

#Permanova
Here we modify the data make permanova. For the argument we can use: *Bee...Gut* *Place.local* *Place_Ossetia* *Hight1*. 
*Try to make the cicle with this arguments. Mb it will be faster.
```{r}
set.seed(1)
erie_bray <- phyloseq::distance(fin.phy.nrep, method = "bray")
# make a data frame from the sample_data
sampledf <- data.frame(sample_data(fin.phy.nrep))


```

```{r}
#Bee...Gut
adonis(erie_bray ~ Bee...Gut, data = sampledf)
beta <- betadisper(erie_bray, sampledf$Bee...Gut)
permutest(beta)

#Place.local
adonis(erie_bray ~ Place.local, data = sampledf)
beta <- betadisper(erie_bray, sampledf$Place.local)
permutest(beta)

#Place_Ossetia
adonis(erie_bray ~ Place_Ossetia, data = sampledf)
beta <- betadisper(erie_bray, sampledf$Place_Ossetia)
permutest(beta)

#Hight1
adonis(erie_bray ~ Hight1, data = sampledf)
beta <- betadisper(erie_bray, sampledf$Hight1)
permutest(beta)

```


#Contained ordination
TRY TO UNDERSTAND THE RESULTS!!! 
```{r}
bray_not_na <- phyloseq::distance(physeq = ps_obj1, method = "bray")
cap_ord <- ordinate(
  physeq = ps_obj1, 
  method = "CAP",
  distance = bray_not_na,
  formula = ~ Place.local + Hight
)
cap_plot <- plot_ordination(
  physeq = ps_obj1, 
  ordination = cap_ord, 
  color = "Place.Ossetia", 
  axes = c(1,2)
) + 
  aes(shape = Bee...Gut) + 
  geom_point(aes(colour = Place.Ossetia), alpha = 0.4, size = 4) + 
  geom_point(colour = "grey90", size = 1.5) + 
  scale_color_manual(values = c("#a65628", "red", "#ffae19", "#4daf4a", 
                                "#1919ff", "darkorchid3", "magenta")
  )

arrowmat <- vegan::scores(cap_ord, display = "bp")

arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)

arrow_map <- aes(xend = CAP1, 
                 yend = CAP2, 
                 x = 0, 
                 y = 0, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

label_map <- aes(x = 1.3 * CAP1, 
                 y = 1.3 * CAP2, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

arrowhead = arrow(length = unit(0.02, "npc"))


cap_plot + 
  geom_segment(
    mapping = arrow_map, 
    size = .5, 
    data = arrowdf, 
    color = "gray", 
    arrow = arrowhead
  ) + 
  geom_text(
    mapping = label_map, 
    size = 4,  
    data = arrowdf, 
    show.legend = FALSE
  )

anova(cap_ord)
```

#Bubble plot
Information from Stepan's r doc
```{r}
ggplot(top20melt, aes(x = Sample , y = Family , size = Abundance)) +
  geom_point(data = top20melt %>% filter(Abundance >= 0.1),
             shape = 21,
             colour = "#000000",
             fill = "olivedrab3" ,
             stroke = 1,
             alpha = 0.5) +
  geom_point(data = top20melt %>% filter(Abundance <0.1),
             shape = 4,
             size = 1,
             stroke = 1,
             colour = "#000000",
             fill = "olivedrab3" ,
             alpha = 0.5) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank()) +
  scale_size_area(breaks = c(0, 2000, 4000, 6000, 8000, 10000), max_size = 20) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
labs(x = NULL, y = NULL,
     size = "Abundance (%)")
```

#alfa diversity

```{r}

```


#beta diversity

```{r}
pcoa_bc = ordinate(fin.phy.nrep, "PCoA", "bray") 

plot_ordination(fin.phy.nrep, pcoa_bc, color = "Place.whole") + 
  geom_point(size = 3) 
plot_ordination(fin.phy.nrep, pcoa_bc, color = "Place") + 
  geom_point(size = 3) 
plot_ordination(fin.phy.nrep, pcoa_bc, color = "bee.gut") + 
  geom_point(size = 3)
plot_ordination(fin.phy.nrep, pcoa_bc, color = "Hight1") + 
  geom_point(size = 3)
```


